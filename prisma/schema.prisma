// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Creator {
  id           String              @id @default("creator-1")
  name         String
  subtitle     String
  description  String
  bioLinkEnabled          Boolean @default(false)
  bioLinkTitle            String?
  bioLinkTagline          String?
  bioLinkAvatarUrl        String?
  bioLinkPrimaryCtaLabel  String?
  bioLinkPrimaryCtaUrl    String?
  bioLinkSecondaryLinks   Json?
  packs        Pack[]
  fans         Fan[]
  notes        FanNote[]
  contentItems ContentItem[]
  aiSettings   CreatorAiSettings?
  aiUsageLogs  AiUsageLog[]
  aiTemplates  CreatorAiTemplate[]
  managerConversation ManagerConversation?
  contentManagerConversation ContentManagerConversation?
}

model Pack {
  id          String  @id
  name        String
  price       String
  description String
  creatorId   String
  creator     Creator @relation(fields: [creatorId], references: [id])
}

model Fan {
  id               String          @id
  name             String
  avatar           String?
  preview          String?
  time             String?
  unreadCount      Int             @default(0)
  isNew            Boolean         @default(false)
  membershipStatus String?
  daysLeft         Int?
  lastSeen         String?
  nextAction       String?
  creatorId        String
  creator          Creator         @relation(fields: [creatorId], references: [id])
  messages         Message[]
  accessGrants     AccessGrant[]
  notes            FanNote[]
  extraPurchases   ExtraPurchase[]
  aiUsageLogs      AiUsageLog[]
  segment          String          @default("NUEVO")
  healthScore      Int             @default(0)
  lastMessageAt    DateTime?
  lastCreatorMessageAt DateTime?
  lastPurchaseAt   DateTime?
  lifetimeValue    Float           @default(0)
  recent30dSpend   Float           @default(0)
  riskLevel        String          @default("LOW")
}

model Message {
  id                String       @id
  fanId             String
  from              String
  text              String
  time              String?
  isLastFromCreator Boolean      @default(false)
  fan               Fan          @relation(fields: [fanId], references: [id])
  type              MessageType  @default(TEXT)
  contentItemId     String?
  contentItem       ContentItem? @relation("MessageContentItems", fields: [contentItemId], references: [id])
}

model ContentItem {
  id             String            @id @default(cuid())
  creator        Creator           @relation(fields: [creatorId], references: [id])
  creatorId      String
  pack           ContentPack       @default(WELCOME)
  slug           String?
  type           ContentType
  title          String
  description    String?
  order          Int               @default(0)
  mediaPath      String?
  durationSec    Int?
  isPreview      Boolean           @default(false)
  visibility     ContentVisibility @default(INCLUDED_MONTHLY)
  isExtra        Boolean           @default(false)
  extraTier      ExtraTier?
  timeOfDay      TimeOfDay         @default(ANY)
  externalUrl    String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  messages       Message[]         @relation("MessageContentItems")
  extraPurchases ExtraPurchase[]

  @@unique([creatorId, slug])
  @@index([pack, order])
}

enum ContentType {
  IMAGE
  VIDEO
  AUDIO
  TEXT
}

enum ContentVisibility {
  INCLUDED_MONTHLY
  VIP
  EXTRA
}

enum ContentPack {
  WELCOME
  MONTHLY
  SPECIAL
}

enum ExtraTier {
  T0
  T1
  T2
  T3
  T4
}

enum AiTurnMode {
  HEATUP
  PACK_PUSH
  VIP_CARE
}

enum TimeOfDay {
  DAY
  NIGHT
  ANY
}

enum MessageType {
  TEXT
  CONTENT
}

enum ManagerSender {
  CREATOR
  MANAGER
}

enum ContentManagerSender {
  CREATOR
  MANAGER
}

model AccessGrant {
  id        String   @id @default(cuid())
  fanId     String
  fan       Fan      @relation(fields: [fanId], references: [id])
  type      String
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model FanNote {
  id        String   @id @default(cuid())
  fan       Fan      @relation(fields: [fanId], references: [id])
  fanId     String
  creator   Creator  @relation(fields: [creatorId], references: [id])
  creatorId String
  content   String
  createdAt DateTime @default(now())
}

model ExtraPurchase {
  id            String      @id @default(cuid())
  fan           Fan         @relation(fields: [fanId], references: [id])
  fanId         String
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id])
  contentItemId String
  tier          ExtraTier
  amount        Int
  sessionTag    String?
  createdAt     DateTime    @default(now())
}

model CreatorAiSettings {
  id        Int     @id @default(autoincrement())
  creatorId String  @unique
  creator   Creator @relation(fields: [creatorId], references: [id])

  tone           String @default("cercano")
  spicinessLevel Int    @default(1)
  formalityLevel Int    @default(1)
  emojiUsage     Int    @default(1)

  priorityOrderJson Json?

  forbiddenTopics   String?
  forbiddenPromises String?
  rulesManifest     String?

  allowSuggestReplies  Boolean @default(true)
  allowSuggestExtras   Boolean @default(true)
  allowSuggestRenewals Boolean @default(true)
  allowAutoLowPriority Boolean @default(false)

  creditsAvailable Int  @default(0)
  hardLimitPerDay  Int?
  turnMode         AiTurnMode @default(HEATUP)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AiUsageLog {
  id        Int     @id @default(autoincrement())
  creatorId String
  creator   Creator @relation(fields: [creatorId], references: [id])

  fanId String?
  fan   Fan?    @relation(fields: [fanId], references: [id])

  actionType     String
  contextSummary String?
  suggestedText  String
  outcome        String
  finalText      String?

  creditsUsed Int      @default(1)
  createdAt   DateTime @default(now())
  turnMode    AiTurnMode @default(HEATUP)
}

model CreatorAiTemplate {
  id        String  @id @default(cuid())
  creatorId String
  creator   Creator @relation(fields: [creatorId], references: [id])

  name     String
  category String
  tone     String?
  content  String

  tier ExtraTier?

  isActive Boolean @default(true)
  mode     AiTurnMode?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ManagerConversation {
  id        String           @id @default(cuid())
  creator   Creator          @relation(fields: [creatorId], references: [id])
  creatorId String           @unique
  messages  ManagerMessage[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

model ManagerMessage {
  id             String              @id @default(cuid())
  conversation   ManagerConversation @relation(fields: [conversationId], references: [id])
  conversationId String
  sender         ManagerSender
  content        String
  createdAt      DateTime            @default(now())

  @@index([conversationId, createdAt])
}

model ContentManagerConversation {
  id        String                 @id @default(cuid())
  creator   Creator                @relation(fields: [creatorId], references: [id])
  creatorId String                 @unique
  messages  ContentManagerMessage[]
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
}

model ContentManagerMessage {
  id             String                     @id @default(cuid())
  conversation   ContentManagerConversation @relation(fields: [conversationId], references: [id])
  conversationId String
  sender         ContentManagerSender
  content        String
  createdAt      DateTime                   @default(now())

  @@index([conversationId, createdAt])
}
