// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Creator {
  id           String              @id @default("creator-1")
  name         String
  subtitle     String
  description  String
  bioLinkEnabled          Boolean @default(false)
  bioLinkTitle            String?
  bioLinkTagline          String?
  bioLinkAvatarUrl        String?
  bioLinkPrimaryCtaLabel  String?
  bioLinkPrimaryCtaUrl    String?
  bioLinkSecondaryLinks   Json?
  bioLinkDescription      String?
  bioLinkFaq              Json?
  packs        Pack[]
  fans         Fan[]
  notes        FanNote[]
  contentItems ContentItem[]
  catalogItems CatalogItem[]
  popClips     PopClip[]
  aiSettings   CreatorAiSettings?
  aiUsageLogs  AiUsageLog[]
  aiTemplates  CreatorAiTemplate[]
  managerConversation ManagerConversation?
  contentManagerConversation ContentManagerConversation?
  managerAiMessages ManagerAiMessage[]
  discoveryProfile   CreatorDiscoveryProfile?
  discoveryFeedbacks DiscoveryFeedback[]
  profile      CreatorProfile?
  generatedAssets GeneratedAsset[]
  campaigns   CampaignMeta[]
  followUps   FanFollowUp[]
}

model CreatorProfile {
  id        String   @id @default(cuid())
  creatorId String   @unique
  creator   Creator  @relation(fields: [creatorId], references: [id])
  coverUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Pack {
  id          String  @id
  name        String
  price       String
  description String
  creatorId   String
  creator     Creator @relation(fields: [creatorId], references: [id])
}

model Fan {
  id               String          @id
  name             String
  displayName      String?
  creatorLabel     String?
  avatar           String?
  preview          String?
  time             String?
  unreadCount      Int             @default(0)
  isNew            Boolean         @default(false)
  membershipStatus String?
  daysLeft         Int?
  lastSeen         String?
  nextAction       String?
  nextActionAt     DateTime?
  nextActionNote   String?
  profileText      String?
  quickNote        String?
  attendedAt       DateTime?
  creatorId        String
  creator          Creator         @relation(fields: [creatorId], references: [id])
  messages         Message[]
  accessGrants     AccessGrant[]
  notes            FanNote[]
  followUps        FanFollowUp[]
  extraPurchases   ExtraPurchase[]
  aiUsageLogs      AiUsageLog[]
  segment          String          @default("NUEVO")
  healthScore      Int             @default(0)
  lastMessageAt    DateTime?
  lastCreatorMessageAt DateTime?
  lastReadAtCreator DateTime?
  lastReadAtFan     DateTime?
  lastActivityAt   DateTime?
  lastCortexOutreachAt DateTime?
  lastCortexOutreachKey String?
  lastPurchaseAt   DateTime?
  lifetimeValue    Float           @default(0)
  recent30dSpend   Float           @default(0)
  riskLevel        String          @default("LOW")
  isBlocked        Boolean         @default(false)
  isArchived       Boolean         @default(false)
  isHighPriority   Boolean         @default(false)
  highPriorityAt   DateTime?
  inviteToken      String?         @unique
  inviteCreatedAt  DateTime?
  inviteUsedAt     DateTime?
  source           String?
  handle           String?
  preferredLanguage String         @default("en")
  firstUtmSource   String?
  firstUtmMedium   String?
  firstUtmCampaign String?
  firstUtmContent  String?
  firstUtmTerm     String?
}

enum FanFollowUpStatus {
  OPEN
  DONE
  DELETED
}

model FanFollowUp {
  id        String            @id @default(cuid())
  fanId     String
  creatorId String
  title     String
  note      String?
  dueAt     DateTime?
  status    FanFollowUpStatus @default(OPEN)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  doneAt    DateTime?
  fan       Fan               @relation(fields: [fanId], references: [id])
  creator   Creator           @relation(fields: [creatorId], references: [id])

  @@index([fanId, creatorId, status])
  @@index([creatorId, status, dueAt])
}

model Message {
  id                String       @id
  fanId             String
  from              String
  audience          MessageAudience @default(FAN)
  text              String
  deliveredText     String?
  creatorTranslatedText String?
  time              String?
  isLastFromCreator Boolean      @default(false)
  fan               Fan          @relation(fields: [fanId], references: [id])
  type              MessageType  @default(TEXT)
  contentItemId     String?
  contentItem       ContentItem? @relation("MessageContentItems", fields: [contentItemId], references: [id])
  stickerId         String?
  audioUrl          String?
  audioDurationMs   Int?
  audioMime         String?
  audioSizeBytes    Int?
  transcriptText     String?
  transcriptStatus   String  @default("OFF")
  transcriptError    String?
  transcribedAt      DateTime?
  transcriptLang     String?
  intentJson         Json?
  voiceAnalysisJson  String?
  voiceAnalysisUpdatedAt DateTime?
  messageReactions   MessageReaction[]
  messageTranslations MessageTranslation[]
}

model MessageTranslation {
  id                 String   @id @default(cuid())
  messageId          String
  targetLang         String
  sourceKind         String
  sourceHash         String
  translatedText     String
  detectedSourceLang String?
  provider           String?
  createdAt          DateTime @default(now())
  createdByCreatorId String?
  message            Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, targetLang, sourceKind, sourceHash])
  @@index([messageId, targetLang])
}

model MessageReaction {
  id        String            @id @default(cuid())
  messageId String
  actorType ReactionActorType
  actorId   String
  emoji     String
  createdAt DateTime          @default(now())
  message   Message           @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, actorType, actorId])
  @@index([messageId])
}

model ContentItem {
  id             String            @id @default(cuid())
  creator        Creator           @relation(fields: [creatorId], references: [id])
  creatorId      String
  pack           ContentPack       @default(WELCOME)
  slug           String?
  type           ContentType
  title          String
  description    String?
  order          Int               @default(0)
  mediaPath      String?
  durationSec    Int?
  isPreview      Boolean           @default(false)
  visibility     ContentVisibility @default(INCLUDED_MONTHLY)
  isExtra        Boolean           @default(false)
  extraTier      ExtraTier?
  timeOfDay      TimeOfDay         @default(ANY)
  externalUrl    String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  messages       Message[]         @relation("MessageContentItems")
  extraPurchases ExtraPurchase[]
  popClips       PopClip[]

  @@unique([creatorId, slug])
  @@index([pack, order])
}

enum ContentType {
  IMAGE
  VIDEO
  AUDIO
  TEXT
}

enum ContentVisibility {
  INCLUDED_MONTHLY
  VIP
  EXTRA
}

enum ContentPack {
  WELCOME
  MONTHLY
  SPECIAL
}

enum ExtraTier {
  T0
  T1
  T2
  T3
  T4
}

enum ExtraPurchaseKind {
  EXTRA
  TIP
  GIFT
}

enum ExtraPurchaseProductType {
  EXTRA
  PACK
  BUNDLE
  SUBSCRIPTION
}

enum CatalogItemType {
  EXTRA
  BUNDLE
  PACK
}

model CatalogItem {
  id          String          @id @default(cuid())
  creatorId   String
  creator     Creator         @relation(fields: [creatorId], references: [id])
  type        CatalogItemType
  title       String
  description String?
  includes    Json?
  priceCents  Int
  currency    String          @default("EUR")
  isActive    Boolean         @default(true)
  isPublic    Boolean         @default(true)
  sortOrder   Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  popClips    PopClip[]

  @@index([creatorId, isActive, sortOrder, createdAt])
}

model PopClip {
  id            String      @id @default(cuid())
  creatorId     String
  creator       Creator     @relation(fields: [creatorId], references: [id])
  catalogItemId String?
  catalogItem   CatalogItem? @relation(fields: [catalogItemId], references: [id])
  contentItemId String?
  contentItem   ContentItem? @relation(fields: [contentItemId], references: [id])
  title         String?
  videoUrl      String
  posterUrl     String?
  startAtSec    Int         @default(0)
  durationSec   Int?
  isActive      Boolean     @default(true)
  sortOrder     Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([creatorId, isActive, sortOrder])
  @@unique([creatorId, catalogItemId])
  @@unique([creatorId, contentItemId])
}

enum ManagerAiTab {
  STRATEGY
  CONTENT
  GROWTH
}

enum ManagerAiRole {
  CREATOR
  ASSISTANT
}

enum AiUsageOrigin {
  FAN_ASSISTANT
  MANAGER_STRATEGY
  MANAGER_CONTENT
  MANAGER_GROWTH
}

enum AiUsageType {
  FAN_ASSISTANT
  MANAGER
}

enum AiTurnMode {
  auto       @map("HEATUP")
  push_pack  @map("PACK_PUSH")
  care_new   @map("CARE_NEW")
  vip_focus  @map("VIP_CARE")
}

enum TimeOfDay {
  DAY
  NIGHT
  ANY
}

enum MessageType {
  TEXT
  CONTENT
  STICKER
  AUDIO
  VOICE
}

enum MessageAudience {
  FAN
  CREATOR
  INTERNAL
}

enum ReactionActorType {
  FAN
  CREATOR
}

enum GeneratedAssetPurpose {
  AVATAR
  COVER
}

enum ManagerSender {
  CREATOR
  MANAGER
}

enum ContentManagerSender {
  CREATOR
  MANAGER
}

model AccessGrant {
  id        String   @id @default(cuid())
  fanId     String
  fan       Fan      @relation(fields: [fanId], references: [id])
  type      String
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model FanNote {
  id        String   @id @default(cuid())
  fan       Fan      @relation(fields: [fanId], references: [id])
  fanId     String
  creator   Creator  @relation(fields: [creatorId], references: [id])
  creatorId String
  content   String
  createdAt DateTime @default(now())
}

model ExtraPurchase {
  id            String      @id @default(cuid())
  fan           Fan         @relation(fields: [fanId], references: [id])
  fanId         String
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id])
  contentItemId String
  tier          ExtraTier
  amount        Int
  kind          ExtraPurchaseKind @default(EXTRA)
  productId     String?
  productType   ExtraPurchaseProductType?
  sessionTag    String?
  clientTxnId   String?
  createdAt     DateTime    @default(now())
  isArchived    Boolean     @default(false)

  @@unique([fanId, kind, clientTxnId])
}

model GeneratedAsset {
  id        String                @id
  creatorId String
  creator   Creator               @relation(fields: [creatorId], references: [id])
  purpose   GeneratedAssetPurpose
  prompt    String
  url       String
  createdAt DateTime              @default(now())

  @@index([creatorId, createdAt])
}

model CreatorAiSettings {
  id        Int     @id @default(autoincrement())
  creatorId String  @unique
  creator   Creator @relation(fields: [creatorId], references: [id])

  tone           String @default("cercano")
  spicinessLevel Int    @default(1)
  formalityLevel Int    @default(1)
  emojiUsage     Int    @default(1)

  priorityOrderJson Json?

  forbiddenTopics   String?
  forbiddenPromises String?
  rulesManifest     String?

  allowSuggestReplies  Boolean @default(true)
  allowSuggestExtras   Boolean @default(true)
  allowSuggestRenewals Boolean @default(true)
  allowAutoLowPriority Boolean @default(false)
  voiceTranscriptionMode String @default("MANUAL")
  voiceTranscriptionMinSeconds Int @default(8)
  voiceTranscriptionDailyBudgetMinutes Int @default(15)
  voiceTranscriptionDailyBudgetUsd Float @default(0.5)
  voiceIntentTagsEnabled Boolean @default(false)
  voiceTranscriptionExtractIntentTags Boolean @default(false)
  voiceTranscriptionSuggestReply Boolean @default(false)

  creditsAvailable Int  @default(0)
  hardLimitPerDay  Int?
  turnMode         AiTurnMode @default(auto)
  platforms        Json?

  translateProvider      String?
  libretranslateUrl      String?
  libretranslateApiKeyEnc String?
  deeplApiUrl             String?
  deeplApiKeyEnc          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AiUsageLog {
  id        String        @id @default(cuid())
  creatorId String
  creator   Creator       @relation(fields: [creatorId], references: [id])

  fanId String?
  fan   Fan?    @relation(fields: [fanId], references: [id])

  type        AiUsageType   @default(FAN_ASSISTANT)
  origin      AiUsageOrigin @default(FAN_ASSISTANT)
  creditsUsed Int           @default(1)
  context     Json?
  createdAt   DateTime      @default(now())
  turnMode    AiTurnMode    @default(auto)

  // Campos heredados para compatibilidad con usos anteriores
  actionType     String?
  contextSummary String?
  suggestedText  String?
  outcome        String?
  finalText      String?
}

model CreatorAiTemplate {
  id        String  @id @default(cuid())
  creatorId String
  creator   Creator @relation(fields: [creatorId], references: [id])

  name     String
  category String
  tone     String?
  content  String

  tier ExtraTier?

  isActive Boolean @default(true)
  mode     AiTurnMode?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ManagerConversation {
  id        String           @id @default(cuid())
  creator   Creator          @relation(fields: [creatorId], references: [id])
  creatorId String           @unique
  messages  ManagerMessage[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

model ManagerMessage {
  id             String              @id @default(cuid())
  conversation   ManagerConversation @relation(fields: [conversationId], references: [id])
  conversationId String
  sender         ManagerSender
  content        String
  createdAt      DateTime            @default(now())

  @@index([conversationId, createdAt])
}

model ContentManagerConversation {
  id        String                 @id @default(cuid())
  creator   Creator                @relation(fields: [creatorId], references: [id])
  creatorId String                 @unique
  messages  ContentManagerMessage[]
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
}

model ContentManagerMessage {
  id             String                     @id @default(cuid())
  conversation   ContentManagerConversation @relation(fields: [conversationId], references: [id])
  conversationId String
  sender         ContentManagerSender
  content        String
  createdAt      DateTime                   @default(now())

  @@index([conversationId, createdAt])
}

model ManagerAiMessage {
  id          String         @id @default(cuid())
  creatorId   String
  tab         ManagerAiTab
  role        ManagerAiRole
  content     String
  creditsUsed Int            @default(0)
  meta        Json?
  createdAt   DateTime       @default(now())

  creator Creator @relation(fields: [creatorId], references: [id])

  @@index([creatorId, tab, createdAt])
}

model AnalyticsEvent {
  id          String   @id @default(uuid())
  creatorId   String
  fanId       String?
  sessionId   String
  eventName   String
  path        String
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?
  meta        Json?
  createdAt   DateTime @default(now())

  @@index([creatorId, createdAt])
  @@index([eventName, createdAt])
  @@index([utmCampaign, utmContent])
}

model CampaignLink {
  id          String   @id @default(uuid())
  creatorId   String
  handle      String?
  platform    String
  utmSource   String
  utmMedium   String
  utmCampaign String
  utmContent  String
  utmTerm     String?
  slug        String?  @unique
  createdAt   DateTime @default(now())

  @@index([creatorId, createdAt])
}

model CampaignMeta {
  id          String   @id @default(cuid())
  creatorId   String
  creator     Creator  @relation(fields: [creatorId], references: [id])
  utmCampaign String
  title       String
  objective   String
  platform    String
  status      String
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([creatorId, utmCampaign])
  @@index([creatorId, createdAt])
}

model CreatorDiscoveryProfile {
  id                    String   @id @default(cuid())
  creatorId             String   @unique
  creator               Creator  @relation(fields: [creatorId], references: [id])
  isDiscoverable        Boolean  @default(false)
  niches                String   @default("")
  communicationStyle    String
  limits                String?
  priceMin              Int?
  priceMax              Int?
  responseHours         Int?
  allowLocationMatching Boolean  @default(false)
  showCountry           Boolean  @default(false)
  showCityApprox        Boolean  @default(false)
  country               String?
  cityApprox            String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model DiscoveryFeedback {
  id        String   @id @default(cuid())
  sessionId String
  creatorId String
  creator   Creator  @relation(fields: [creatorId], references: [id])
  vote      String
  createdAt DateTime @default(now())

  @@index([creatorId])
  @@index([sessionId])
}
