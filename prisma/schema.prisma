// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Creator {
  id                         String                      @id @default("creator-1")
  name                       String
  handle                     String?                     @unique
  isVerified                 Boolean                     @default(false)
  offerTags                  Json?
  subtitle                   String
  uiLocale                   String                      @default("es")
  description                String
  bioLinkEnabled             Boolean                     @default(false)
  bioLinkTitle               String?
  bioLinkTagline             String?
  bioLinkAvatarUrl           String?
  bioLinkPrimaryCtaLabel     String?
  bioLinkPrimaryCtaUrl       String?
  bioLinkSecondaryLinks      Json?
  bioLinkDescription         String?
  bioLinkFaq                 Json?
  packs                      Pack[]
  fans                       Fan[]
  followers                  Follow[]
  notes                      FanNote[]
  contentItems               ContentItem[]
  catalogItems               CatalogItem[]
  popClips                   PopClip[]
  aiSettings                 CreatorAiSettings?
  aiUsageLogs                AiUsageLog[]
  aiTemplates                CreatorAiTemplate[]
  managerConversation        ManagerConversation?
  contentManagerConversation ContentManagerConversation?
  managerAiMessages          ManagerAiMessage[]
  discoveryProfile           CreatorDiscoveryProfile?
  discoveryFeedbacks         DiscoveryFeedback[]
  profile                    CreatorProfile?
  generatedAssets            GeneratedAsset[]
  campaigns                  CampaignMeta[]
  utmLinks                   UTMLink[]
  followUps                  FanFollowUp[]
  chatAgencyMetas            ChatAgencyMeta[]
  agencyObjectives           AgencyObjective[]
  offers                     Offer[]
  agencyTemplates            AgencyTemplate[]
  ppvMessages                PpvMessage[]
  ppvPurchases               PpvPurchase[]
  creatorComments            CreatorComment[]
  commentReplies             CommentReply[]
  accessRequests             AccessRequest[]
  fanBlocks                  CreatorFanBlock[]
}

model CreatorProfile {
  id                        String   @id @default(cuid())
  creatorId                 String   @unique
  creator                   Creator  @relation(fields: [creatorId], references: [id])
  isVerified                Boolean  @default(false)
  isAdult                   Boolean  @default(false)
  offerTags                 Json?
  plan                      CreatorPlan @default(FREE)
  coverUrl                  String?
  websiteUrl                String?
  visibilityMode            CreatorVisibilityMode @default(SOLO_LINK)
  locationVisibility        String   @default("OFF")
  locationLabel             String?
  locationPlaceId           String?
  locationGeohash           String?
  locationRadiusKm          Int?
  locationEnabled           Boolean  @default(false)
  locationLat               Float?
  locationLng               Float?
  locationPrecisionKm       Int      @default(3)
  allowDiscoveryUseLocation Boolean  @default(false)
  responseSla               CreatorResponseSla @default(LT_24H)
  availability              CreatorAvailability @default(AVAILABLE)
  vipOnly                   Boolean  @default(false)
  popclipPreviewLimit       Int      @default(3)
  ratingAvg                 Float?
  ratingCount               Int      @default(0)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

enum CreatorPlan {
  FREE
  PRO
}

enum CreatorVisibilityMode {
  INVISIBLE
  SOLO_LINK
  DISCOVERABLE
  PUBLIC
}

enum CreatorResponseSla {
  INSTANT
  LT_24H
  LT_72H
}

enum CreatorAvailability {
  AVAILABLE
  NOT_AVAILABLE
  VIP_ONLY
  OFFLINE
}

model Pack {
  id          String  @id
  name        String
  price       String
  description String
  creatorId   String
  creator     Creator @relation(fields: [creatorId], references: [id])
}

model Fan {
  id                    String           @id
  name                  String
  displayName           String?
  creatorLabel          String?
  avatar                String?
  preview               String?
  time                  String?
  unreadCount           Int              @default(0)
  isNew                 Boolean          @default(false)
  membershipStatus      String?
  daysLeft              Int?
  lastSeen              String?
  nextAction            String?
  nextActionAt          DateTime?
  nextActionNote        String?
  profileText           String?
  quickNote             String?
  attendedAt            DateTime?
  creatorId             String
  creator               Creator          @relation(fields: [creatorId], references: [id])
  messages              Message[]
  accessGrants          AccessGrant[]
  notes                 FanNote[]
  followUps             FanFollowUp[]
  extraPurchases        ExtraPurchase[]
  popClipReactions      PopClipReaction[]
  popClipComments       PopClipComment[]
  popClipSaves          PopClipSave[]
  popClipReports        PopClipReport[]
  commentReplies        CommentReply[]
  accessRequests        AccessRequest[]
  fanBlocks             CreatorFanBlock[]
  aiUsageLogs           AiUsageLog[]
  segment               String           @default("NUEVO")
  healthScore           Int              @default(0)
  lastMessageAt         DateTime?
  lastCreatorMessageAt  DateTime?
  lastReadAtCreator     DateTime?
  lastReadAtFan         DateTime?
  lastActivityAt        DateTime?
  lastCortexOutreachAt  DateTime?
  lastCortexOutreachKey String?
  lastPurchaseAt        DateTime?
  lifetimeValue         Float            @default(0)
  recent30dSpend        Float            @default(0)
  riskLevel             String           @default("LOW")
  isBlocked             Boolean          @default(false)
  isArchived            Boolean          @default(false)
  isHighPriority        Boolean          @default(false)
  highPriorityAt        DateTime?
  adultConfirmedAt      DateTime?
  adultConfirmVersion   String?
  inviteToken           String?          @unique
  inviteCreatedAt       DateTime?
  inviteUsedAt          DateTime?
  source                String?
  handle                String?
  preferredLanguage     String           @default("en")
  locale                String?
  firstUtmSource        String?
  firstUtmMedium        String?
  firstUtmCampaign      String?
  firstUtmContent       String?
  firstUtmTerm          String?
  heatScore             Int              @default(0)
  heatLabel             String?
  heatUpdatedAt         DateTime?
  heatMeta              Json?
  lastIntentKey         String?
  lastIntentConfidence  Float?
  lastIntentAt          DateTime?
  lastInboundAt         DateTime?
  signalsUpdatedAt      DateTime?
  temperatureScore      Float?
  temperatureBucket     String?
  agencyMetas           ChatAgencyMeta[]
  wallet                Wallet?
  ppvMessages           PpvMessage[]
  ppvPurchases          PpvPurchase[]
  creatorComments       CreatorComment[]
  creatorCommentHelpfulVotes CreatorCommentHelpfulVote[]
}

enum FanFollowUpStatus {
  OPEN
  DONE
  DELETED
}

enum AgencyStage {
  NEW
  WARM_UP
  HEAT
  OFFER
  CLOSE
  AFTERCARE
  RECOVERY
  BOUNDARY
}

enum AgencyObjectiveKind {
  CONNECT
  SELL_EXTRA
  SELL_PACK
  SELL_MONTHLY
  RECOVER
  RETAIN
  UPSELL
}

enum AgencyIntensity {
  SOFT
  MEDIUM
  INTENSE
}

enum AgencyPlaybook {
  GIRLFRIEND
  PLAYFUL
  ELEGANT
  SOFT_DOMINANT
}

enum OfferTier {
  MICRO
  STANDARD
  PREMIUM
  MONTHLY
}

model ChatAgencyMeta {
  id                 String          @id @default(cuid())
  creatorId          String
  fanId              String
  stage              AgencyStage     @default(NEW)
  objectiveCode      String          @default("CONNECT")
  intensity          AgencyIntensity @default(MEDIUM)
  playbook           AgencyPlaybook  @default(GIRLFRIEND)
  nextAction         String?
  lastTouchAt        DateTime?
  notes              String?
  recommendedOfferId String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  creator            Creator         @relation(fields: [creatorId], references: [id])
  fan                Fan             @relation(fields: [fanId], references: [id])

  @@unique([creatorId, fanId])
  @@index([creatorId, fanId])
  @@index([creatorId, stage])
  @@index([creatorId, objectiveCode])
}

model AgencyTemplate {
  id         String              @id @default(cuid())
  creatorId  String
  stage      AgencyStage
  objective  AgencyObjectiveKind
  intensity  AgencyIntensity
  playbook   AgencyPlaybook      @default(GIRLFRIEND)
  language   String              @default("es")
  blocksJson Json
  active     Boolean             @default(true)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  creator    Creator             @relation(fields: [creatorId], references: [id])

  @@index([creatorId, playbook, stage, objective, intensity])
  @@index([creatorId, language, active])
}

model AgencyObjective {
  id        String   @id @default(cuid())
  creatorId String
  code      String
  labels    Json
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  creator   Creator  @relation(fields: [creatorId], references: [id])

  @@unique([creatorId, code])
  @@index([creatorId, active])
}

model Offer {
  id           String          @id @default(cuid())
  creatorId    String
  code         String
  title        String
  tier         OfferTier
  priceCents   Int
  currency     String          @default("EUR")
  oneLiner     String
  hooksJson    Json
  ctasJson     Json
  intensityMin AgencyIntensity @default(SOFT)
  active       Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  creator      Creator         @relation(fields: [creatorId], references: [id])

  @@unique([creatorId, code])
  @@index([creatorId, active])
  @@index([creatorId, tier])
}

model FanFollowUp {
  id        String            @id @default(cuid())
  fanId     String
  creatorId String
  title     String
  note      String?
  dueAt     DateTime?
  status    FanFollowUpStatus @default(OPEN)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  doneAt    DateTime?
  fan       Fan               @relation(fields: [fanId], references: [id])
  creator   Creator           @relation(fields: [creatorId], references: [id])

  @@index([fanId, creatorId, status])
  @@index([creatorId, status, dueAt])
}

model Message {
  id                     String               @id
  fanId                  String
  from                   String
  audience               MessageAudience      @default(FAN)
  text                   String
  deliveredText          String?
  creatorTranslatedText  String?
  time                   String?
  isLastFromCreator      Boolean              @default(false)
  fan                    Fan                  @relation(fields: [fanId], references: [id])
  type                   MessageType          @default(TEXT)
  contentItemId          String?
  contentItem            ContentItem?         @relation("MessageContentItems", fields: [contentItemId], references: [id])
  stickerId              String?
  audioUrl               String?
  audioDurationMs        Int?
  audioMime              String?
  audioSizeBytes         Int?
  transcriptText         String?
  transcriptStatus       String               @default("OFF")
  transcriptError        String?
  transcribedAt          DateTime?
  transcriptLang         String?
  intentKey              String?
  intentConfidence       Float?
  intentMeta             Json?
  intentUpdatedAt        DateTime?
  intentJson             Json?
  voiceAnalysisJson      String?
  voiceAnalysisUpdatedAt DateTime?
  messageReactions       MessageReaction[]
  messageTranslations    MessageTranslation[]
  ppvMessage             PpvMessage?
}

model PpvMessage {
  id         String       @id @default(cuid())
  messageId  String       @unique
  message    Message      @relation(fields: [messageId], references: [id], onDelete: Cascade)
  fanId      String
  creatorId  String
  title      String?
  priceCents Int
  currency   String       @default("EUR")
  status     PpvMessageStatus @default(PENDING)
  soldAt     DateTime?
  purchaseId String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  fan        Fan          @relation(fields: [fanId], references: [id])
  creator    Creator      @relation(fields: [creatorId], references: [id])
  purchases  PpvPurchase[]

  @@index([fanId, createdAt])
  @@index([creatorId, createdAt])
}

model PpvPurchase {
  id           String            @id @default(cuid())
  ppvMessageId String
  ppvMessage   PpvMessage        @relation(fields: [ppvMessageId], references: [id], onDelete: Cascade)
  fanId        String
  creatorId    String
  amountCents  Int
  currency     String            @default("EUR")
  status       PpvPurchaseStatus @default(PAID)
  createdAt    DateTime          @default(now())
  fan          Fan               @relation(fields: [fanId], references: [id])
  creator      Creator           @relation(fields: [creatorId], references: [id])

  @@unique([ppvMessageId, fanId], name: "PpvPurchase_ppvMessageId_fanId_key")
  @@index([fanId, createdAt])
  @@index([creatorId, createdAt])
}

model MessageTranslation {
  id                 String   @id @default(cuid())
  messageId          String
  targetLang         String
  sourceKind         String
  sourceHash         String
  translatedText     String
  detectedSourceLang String?
  provider           String?
  createdAt          DateTime @default(now())
  createdByCreatorId String?
  message            Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, targetLang, sourceKind, sourceHash])
  @@index([messageId, targetLang])
}

model MessageReaction {
  id        String            @id @default(cuid())
  messageId String
  actorType ReactionActorType
  actorId   String
  emoji     String
  createdAt DateTime          @default(now())
  message   Message           @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, actorType, actorId])
  @@index([messageId])
}

model ContentItem {
  id             String            @id @default(cuid())
  creator        Creator           @relation(fields: [creatorId], references: [id])
  creatorId      String
  pack           ContentPack       @default(WELCOME)
  slug           String?
  type           ContentType
  title          String
  description    String?
  order          Int               @default(0)
  mediaPath      String?
  durationSec    Int?
  isPreview      Boolean           @default(false)
  visibility     ContentVisibility @default(INCLUDED_MONTHLY)
  isExtra        Boolean           @default(false)
  extraTier      ExtraTier?
  extraSlot      ExtraSlot?
  chatTier       ChatPpvTier?
  defaultCopy    String?
  timeOfDay      TimeOfDay         @default(ANY)
  externalUrl    String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  messages       Message[]         @relation("MessageContentItems")
  extraPurchases ExtraPurchase[]
  popClips       PopClip[]

  @@unique([creatorId, slug])
  @@index([pack, order])
}

enum ContentType {
  IMAGE
  VIDEO
  AUDIO
  TEXT
}

enum ContentVisibility {
  INCLUDED_MONTHLY
  VIP
  EXTRA
}

enum ContentPack {
  WELCOME
  MONTHLY
  SPECIAL
}

enum ExtraTier {
  T0
  T1
  T2
  T3
  T4
}

enum ExtraSlot {
  DAY_1
  DAY_2
  NIGHT_1
  NIGHT_2
  ANY
}

enum ChatPpvTier {
  CHAT_T0
  CHAT_T1
  CHAT_T2
  CHAT_T3
}

enum ExtraPurchaseKind {
  EXTRA
  TIP
  GIFT
}

enum ExtraPurchaseProductType {
  EXTRA
  PACK
  BUNDLE
  SUBSCRIPTION
}

enum WalletTransactionKind {
  FAKE_TOPUP
  PACK_PURCHASE
  EXTRA_PURCHASE
  PPV_PURCHASE
  REFUND
}

enum PpvMessageStatus {
  PENDING
  SOLD
}

enum PpvPurchaseStatus {
  PAID
}

enum CatalogItemType {
  EXTRA
  BUNDLE
  PACK
}

enum CreatorCommentStatus {
  APPROVED
  HIDDEN
  PENDING
}

enum AccessRequestStatus {
  PENDING
  APPROVED
  REJECTED
  SPAM
}

enum CommentReplyAuthorRole {
  CREATOR
  FAN
}

model CreatorComment {
  id        String               @id @default(cuid())
  creatorId String
  creator   Creator              @relation(fields: [creatorId], references: [id])
  fanId     String
  fan       Fan                  @relation(fields: [fanId], references: [id])
  rating    Int
  text      String
  replyText String? @map("creatorReplyText")
  repliedAt DateTime? @map("creatorReplyAt")
  repliedByCreatorId String?
  replies   CommentReply[]
  helpfulVotes CreatorCommentHelpfulVote[]
  repliesLocked Boolean @default(false)
  isPublic  Boolean              @default(true)
  status    CreatorCommentStatus @default(APPROVED)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  @@unique([creatorId, fanId])
  @@index([creatorId, createdAt])
  @@index([fanId])
}

model CommentReply {
  id              String                 @id @default(cuid())
  commentId       String
  comment         CreatorComment         @relation(fields: [commentId], references: [id], onDelete: Cascade)
  authorRole      CommentReplyAuthorRole
  authorCreatorId String?
  authorCreator   Creator?               @relation(fields: [authorCreatorId], references: [id])
  authorFanId     String?
  authorFan       Fan?                   @relation(fields: [authorFanId], references: [id])
  body            String
  createdAt       DateTime               @default(now())
  deletedAt       DateTime?

  @@index([commentId, createdAt])
  @@index([authorCreatorId])
  @@index([authorFanId])
}

model CreatorCommentHelpfulVote {
  id        String   @id @default(cuid())
  commentId String
  fanId     String
  createdAt DateTime @default(now())

  comment   CreatorComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  fan       Fan           @relation(fields: [fanId], references: [id], onDelete: Cascade)

  @@unique([commentId, fanId])
  @@index([commentId])
  @@index([fanId])
}

model CatalogItem {
  id          String          @id @default(cuid())
  creatorId   String
  creator     Creator         @relation(fields: [creatorId], references: [id])
  type        CatalogItemType
  title       String
  description String?
  includes    Json?
  priceCents  Int
  currency    String          @default("EUR")
  isActive    Boolean         @default(true)
  isPublic    Boolean         @default(true)
  sortOrder   Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  popClips    PopClip[]

  @@index([creatorId, isActive, sortOrder, createdAt])
}

model PopClip {
  id            String       @id @default(cuid())
  creatorId     String
  creator       Creator      @relation(fields: [creatorId], references: [id])
  catalogItemId String?
  catalogItem   CatalogItem? @relation(fields: [catalogItemId], references: [id])
  contentItemId String?
  contentItem   ContentItem? @relation(fields: [contentItemId], references: [id])
  title         String?
  caption       String?
  videoUrl      String
  posterUrl     String?
  isSensitive   Boolean      @default(false)
  startAtSec    Int          @default(0)
  durationSec   Int?
  videoWidth    Int?
  videoHeight   Int?
  videoSizeBytes Int?
  savesCount    Int          @default(0)
  isActive      Boolean      @default(true)
  isArchived    Boolean      @default(false)
  isStory       Boolean      @default(false)
  sortOrder     Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  reactions     PopClipReaction[]
  comments      PopClipComment[]
  saves         PopClipSave[]
  reports       PopClipReport[]

  @@unique([creatorId, catalogItemId])
  @@unique([creatorId, contentItemId])
  @@index([creatorId, isActive, sortOrder])
}

model PopClipReaction {
  id        String   @id @default(cuid())
  popClipId String
  popClip   PopClip  @relation(fields: [popClipId], references: [id], onDelete: Cascade)
  fanId     String
  fan       Fan      @relation(fields: [fanId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([popClipId, fanId])
  @@index([popClipId])
  @@index([fanId])
}

model PopClipComment {
  id        String   @id @default(cuid())
  popClipId String
  popClip   PopClip  @relation(fields: [popClipId], references: [id], onDelete: Cascade)
  fanId     String
  fan       Fan      @relation(fields: [fanId], references: [id], onDelete: Cascade)
  text      String
  createdAt DateTime @default(now())

  @@index([popClipId])
  @@index([fanId])
  @@index([popClipId, createdAt])
}

model PopClipSave {
  id        String   @id @default(cuid())
  popClipId String
  popClip   PopClip  @relation(fields: [popClipId], references: [id], onDelete: Cascade)
  fanId     String
  fan       Fan      @relation(fields: [fanId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([popClipId, fanId])
  @@index([popClipId])
  @@index([fanId])
}

enum SavedItemType {
  POPCLIP
  PACK
  CREATOR
}

model SavedCollection {
  id        String   @id @default(cuid())
  userId    String
  name      String
  isPrivate Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     SavedItem[]

  @@index([userId, sortOrder])
  @@unique([userId, name])
}

model SavedItem {
  id           String        @id @default(cuid())
  userId       String
  type         SavedItemType
  entityId     String
  collectionId String?
  createdAt    DateTime      @default(now())

  collection   SavedCollection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)

  @@unique([userId, type, entityId])
  @@index([userId, createdAt])
  @@index([userId, collectionId])
}

model Follow {
  id        String   @id @default(cuid())
  fanId     String
  creatorId String
  createdAt DateTime @default(now())

  creator   Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([fanId, creatorId])
  @@index([fanId, createdAt])
  @@index([creatorId, createdAt])
}

model PopClipReport {
  id        String   @id @default(cuid())
  popClipId String
  popClip   PopClip  @relation(fields: [popClipId], references: [id], onDelete: Cascade)
  fanId     String?
  fan       Fan?     @relation(fields: [fanId], references: [id], onDelete: SetNull)
  reason    String?
  createdAt DateTime @default(now())

  @@unique([popClipId, fanId])
  @@index([popClipId])
  @@index([fanId])
  @@index([popClipId, createdAt])
}

enum ManagerAiTab {
  STRATEGY
  CONTENT
  GROWTH
}

enum ManagerAiRole {
  CREATOR
  ASSISTANT
}

enum AiUsageOrigin {
  FAN_ASSISTANT
  MANAGER_STRATEGY
  MANAGER_CONTENT
  MANAGER_GROWTH
}

enum AiUsageType {
  FAN_ASSISTANT
  MANAGER
}

enum AiTurnMode {
  auto      @map("HEATUP")
  push_pack @map("PACK_PUSH")
  care_new  @map("CARE_NEW")
  vip_focus @map("VIP_CARE")
}

enum AdultGatePolicy {
  STRICT
  LEAD_CAPTURE
}

enum TimeOfDay {
  DAY
  NIGHT
  ANY
}

enum MessageType {
  TEXT
  CONTENT
  STICKER
  AUDIO
  VOICE
}

enum MessageAudience {
  FAN
  CREATOR
  INTERNAL
}

enum ReactionActorType {
  FAN
  CREATOR
}

enum GeneratedAssetPurpose {
  AVATAR
  COVER
}

enum ManagerSender {
  CREATOR
  MANAGER
}

enum ContentManagerSender {
  CREATOR
  MANAGER
}

model AccessGrant {
  id        String   @id @default(cuid())
  fanId     String
  fan       Fan      @relation(fields: [fanId], references: [id])
  type      String
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model AccessRequest {
  id         String               @id @default(cuid())
  creatorId  String
  creator    Creator              @relation(fields: [creatorId], references: [id])
  fanId      String
  fan        Fan                  @relation(fields: [fanId], references: [id])
  conversationId String?
  productId  String?
  message    String
  status     AccessRequestStatus  @default(PENDING)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  resolvedAt DateTime?
  resolvedByCreatorId String?

  @@index([creatorId, status, createdAt])
  @@index([fanId, status, createdAt])
}

model CreatorFanBlock {
  id        String   @id @default(cuid())
  creatorId String
  creator   Creator  @relation(fields: [creatorId], references: [id])
  fanId     String
  fan       Fan      @relation(fields: [fanId], references: [id])
  reason    String?
  createdAt DateTime @default(now())

  @@unique([creatorId, fanId])
  @@index([creatorId, createdAt])
  @@index([fanId, createdAt])
}

model FanNote {
  id        String   @id @default(cuid())
  fan       Fan      @relation(fields: [fanId], references: [id])
  fanId     String
  creator   Creator  @relation(fields: [creatorId], references: [id])
  creatorId String
  content   String
  createdAt DateTime @default(now())
}

model ExtraPurchase {
  id            String                    @id @default(cuid())
  fan           Fan                       @relation(fields: [fanId], references: [id])
  fanId         String
  contentItem   ContentItem               @relation(fields: [contentItemId], references: [id])
  contentItemId String
  tier          ExtraTier
  amount        Int
  kind          ExtraPurchaseKind         @default(EXTRA)
  productId     String?
  productType   ExtraPurchaseProductType?
  sessionTag    String?
  clientTxnId   String?
  createdAt     DateTime                  @default(now())
  isArchived    Boolean                   @default(false)

  @@unique([fanId, kind, clientTxnId])
}

model Wallet {
  id           String              @id @default(cuid())
  fanId        String              @unique
  fan          Fan                 @relation(fields: [fanId], references: [id])
  currency     String              @default("EUR")
  balanceCents Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  transactions WalletTransaction[]
}

model WalletTransaction {
  id                String                 @id @default(cuid())
  walletId          String
  wallet            Wallet                 @relation(fields: [walletId], references: [id])
  kind              WalletTransactionKind
  amountCents       Int
  balanceAfterCents Int
  idempotencyKey    String?                @unique
  meta              Json?
  createdAt         DateTime               @default(now())

  @@index([walletId, createdAt])
}

model GeneratedAsset {
  id        String                @id
  creatorId String
  creator   Creator               @relation(fields: [creatorId], references: [id])
  purpose   GeneratedAssetPurpose
  prompt    String
  url       String
  createdAt DateTime              @default(now())

  @@index([creatorId, createdAt])
}

model CreatorAiSettings {
  id        Int     @id @default(autoincrement())
  creatorId String  @unique
  creator   Creator @relation(fields: [creatorId], references: [id])

  tone           String @default("cercano")
  spicinessLevel Int    @default(1)
  formalityLevel Int    @default(1)
  emojiUsage     Int    @default(1)

  priorityOrderJson Json?

  forbiddenTopics   String?
  forbiddenPromises String?
  rulesManifest     String?

  allowSuggestReplies                  Boolean @default(true)
  allowSuggestExtras                   Boolean @default(true)
  allowSuggestRenewals                 Boolean @default(true)
  allowExplicitAdultContent            Boolean @default(false)
  adultGatePolicy                      AdultGatePolicy @default(STRICT)
  allowAutoLowPriority                 Boolean @default(false)
  draftPreviewEnabled                  Boolean @default(false) @map("enableFanDraftPreview")
  voiceTranscriptionMode               String  @default("MANUAL")
  voiceTranscriptionMinSeconds         Int     @default(8)
  voiceTranscriptionDailyBudgetMinutes Int     @default(15)
  voiceTranscriptionDailyBudgetUsd     Float   @default(0.5)
  voiceIntentTagsEnabled               Boolean @default(false)
  voiceTranscriptionExtractIntentTags  Boolean @default(false)
  voiceTranscriptionSuggestReply       Boolean @default(false)

  creditsAvailable Int        @default(0)
  hardLimitPerDay  Int?
  turnMode         AiTurnMode @default(auto)
  platforms        Json?

  translateProvider       String?
  libretranslateUrl       String?
  libretranslateApiKeyEnc String?
  deeplApiUrl             String?
  deeplApiKeyEnc          String?
  cortexProvider          String?
  cortexBaseUrl           String?
  cortexModel             String?
  cortexApiKeyEnc         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AiUsageLog {
  id        String  @id @default(cuid())
  creatorId String
  creator   Creator @relation(fields: [creatorId], references: [id])

  fanId String?
  fan   Fan?    @relation(fields: [fanId], references: [id])

  type        AiUsageType   @default(FAN_ASSISTANT)
  origin      AiUsageOrigin @default(FAN_ASSISTANT)
  creditsUsed Int           @default(1)
  context     Json?
  createdAt   DateTime      @default(now())
  turnMode    AiTurnMode    @default(auto)

  endpoint  String?
  provider  String?
  model     String?
  tokensIn  Int?
  tokensOut Int?
  latencyMs Int?
  ok        Boolean?
  errorCode String?

  // Campos heredados para compatibilidad con usos anteriores
  actionType     String?
  contextSummary String?
  suggestedText  String?
  outcome        String?
  finalText      String?
}

model CreatorAiTemplate {
  id        String  @id @default(cuid())
  creatorId String
  creator   Creator @relation(fields: [creatorId], references: [id])

  name     String
  category String
  tone     String?
  content  String

  tier ExtraTier?

  isActive Boolean     @default(true)
  mode     AiTurnMode?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ManagerConversation {
  id        String           @id @default(cuid())
  creator   Creator          @relation(fields: [creatorId], references: [id])
  creatorId String           @unique
  messages  ManagerMessage[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

model ManagerMessage {
  id             String              @id @default(cuid())
  conversation   ManagerConversation @relation(fields: [conversationId], references: [id])
  conversationId String
  sender         ManagerSender
  content        String
  createdAt      DateTime            @default(now())

  @@index([conversationId, createdAt])
}

model ContentManagerConversation {
  id        String                  @id @default(cuid())
  creator   Creator                 @relation(fields: [creatorId], references: [id])
  creatorId String                  @unique
  messages  ContentManagerMessage[]
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
}

model ContentManagerMessage {
  id             String                     @id @default(cuid())
  conversation   ContentManagerConversation @relation(fields: [conversationId], references: [id])
  conversationId String
  sender         ContentManagerSender
  content        String
  createdAt      DateTime                   @default(now())

  @@index([conversationId, createdAt])
}

model ManagerAiMessage {
  id          String        @id @default(cuid())
  creatorId   String
  tab         ManagerAiTab
  role        ManagerAiRole
  content     String
  creditsUsed Int           @default(0)
  meta        Json?
  createdAt   DateTime      @default(now())

  creator Creator @relation(fields: [creatorId], references: [id])

  @@index([creatorId, tab, createdAt])
}

model AnalyticsEvent {
  id          String   @id @default(uuid())
  creatorId   String
  fanId       String?
  sessionId   String
  eventName   String
  path        String
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?
  meta        Json?
  createdAt   DateTime @default(now())

  @@index([creatorId, createdAt])
  @@index([eventName, createdAt])
  @@index([utmCampaign, utmContent])
}

enum UTMLinkPlatform {
  TIKTOK
  INSTAGRAM
  YOUTUBE
  X
}

model UTMLink {
  id        String          @id @default(uuid())
  creatorId String
  platform  UTMLinkPlatform
  campaign  String
  content   String?
  term      String?
  source    String?
  medium    String          @default("social")
  fullUrl   String
  createdAt DateTime        @default(now())

  creator Creator @relation(fields: [creatorId], references: [id])

  @@index([creatorId, createdAt])
}

model CampaignLink {
  id          String   @id @default(uuid())
  creatorId   String
  handle      String?
  platform    String
  utmSource   String
  utmMedium   String
  utmCampaign String
  utmContent  String
  utmTerm     String?
  slug        String?  @unique
  createdAt   DateTime @default(now())

  @@index([creatorId, createdAt])
}

model CampaignMeta {
  id          String   @id @default(cuid())
  creatorId   String
  creator     Creator  @relation(fields: [creatorId], references: [id])
  utmCampaign String
  title       String
  objective   String
  platform    String
  status      String
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([creatorId, utmCampaign])
  @@index([creatorId, createdAt])
}

model CreatorDiscoveryProfile {
  id                    String   @id @default(cuid())
  creatorId             String   @unique
  creator               Creator  @relation(fields: [creatorId], references: [id])
  isDiscoverable        Boolean  @default(false)
  niches                String   @default("")
  communicationStyle    String
  limits                String?
  priceMin              Int?
  priceMax              Int?
  responseHours         Int?
  allowLocationMatching Boolean  @default(false)
  showCountry           Boolean  @default(false)
  showCityApprox        Boolean  @default(false)
  country               String?
  cityApprox            String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model DiscoveryFeedback {
  id        String   @id @default(cuid())
  sessionId String
  creatorId String
  creator   Creator  @relation(fields: [creatorId], references: [id])
  vote      String
  createdAt DateTime @default(now())

  @@index([creatorId])
  @@index([sessionId])
}

model RateLimitEvent {
  id        String   @id @default(cuid())
  key       String
  fanId     String?
  ip        String?
  endpoint  String
  createdAt DateTime @default(now())

  @@index([key, createdAt])
  @@index([fanId, createdAt])
}
